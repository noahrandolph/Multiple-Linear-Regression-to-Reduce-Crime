---
title: "Lab 4: Regression"
author: "Anamika Sinha"
date: ""
output: pdf_document
--- 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=50), width=60,tidy=TRUE)
```
## Introduction



```{r }
C = read.csv("crime_v2.csv")
nrow(C)
head(C)
```


```{r, include=FALSE}
library(Hmisc)
library(MASS)
library(ggplot2)
library(reshape2)
require("car")
library(corrplot)
library(lmtest)
library(sandwich)
library(stargazer)
```

```{r}
str(C)
```
```{r}
summary(C)
```
```{r}
#describe(C)
```
```{r}
attach(C)
```

```{r }
scatterplotMatrix(C[ , c("crime", "probarr", "probconv","probsen")])
```
```{r }
scatterplotMatrix(C[ , c("crime", "density", "ymale","avgsen")])
```
```{r }
M <- cor(C)
corrplot(M, method="number", type="lower")

```

#Univariate EDA Analysis
```{r }
hist(C$crime, breaks = 20, 
     main = "Crime Rate", xlab = NULL)
```
We notice a posiive skew in crime rate. The distribution is not normal. There is no county with zero crime rate. There are very few counties with high crime rate

```{r }
hist(C$probarr, breaks = 20, 
     main = "Probability Arrest", xlab = NULL)
```
There is a negative skew in probability of arrest.
```{r }
hist(C$probconv, breaks = 20, 
     main = "Probability of Conviction", xlab = NULL)
```
There is a strong positiv skew in data. Also the values above 1 do not make sense for this variable. 


```{r }
hist(C$probsen, breaks = 20, 
     main = "Probability of sentencing", xlab = NULL)
```
Probability of sentencing has a positive skew as well.Also there is value above 1 which is unreasonable.
```{r}
#C <- C[ "probsen" <= 1 & "probconv" <= 1 ,]
#C <- C[ "probsen" <= 1, ]
test <- subset(C, C$probsen <= 1 & C$probconv <= 1 )
test1 <- subset(C, probsen <= 1 & probconv <= 1 )
head(test1)
```

```{r}
nrow(test)
```


```{r}
nrow(C)
head(C)
```


```{r }
hist(C$avgsen, breaks = 20, 
     main = "Average sentence in days", xlab = NULL)
```
If the average sentencin is max upto 20 days, then we are looking at petty crimes only.

```{r }
hist(C$police, breaks = 20, 
     main = "police per capita", xlab = NULL)
```

Has a postive skew with an extreme outlier.

```{r }
hist(density, breaks = 20, 
     main = "density per sq mile", xlab = NULL)
```

```{r }
hist(tax, breaks = 20, 
     main = "tax revenue per capita", xlab = NULL)
```
Again a strong positive skew is seen in data. 


```{r }
hist(pctmin, breaks = 20, 
     main = "Proportion that is non white", xlab = NULL)
```

```{r }
hist(ymale, breaks = 20, 
     main = "proportion of young male", xlab = NULL)
```

```{r }
hist(density, breaks = 20, 
     main = "density per square mile", xlab = NULL)
```


#Looking at crime in individual areas

```{r }
hist(crime[west==1], breaks = 20, 
     main = "crime in west", xlab = NULL)
```
```{r }
hist(crime[urban==1], breaks = 20, 
     main = "crime rate in urban", xlab = NULL)
```

Highest crime rate in Urban and western counties
```{r }
hist(crime[central==1], breaks = 20, 
     main = "crime in central", xlab = NULL)
```
#Creating new variable avgwage
To take into consideration, the wages in all sectors in the absence of number of people in each sector we create an
avgwage variable. This is not the best indicator of wage in a given county, 
```{r}
avgwage = (wagecon + wagefed + wagefir + wageloc + wagemfg + wageser + wagesta + wagetrd + wagetuc) / 9 
```


```{r}
length(avgwage)
summary(avgwage)
```

```{r }
hist(avgwage, breaks = 20, 
     main = "average weekly wage in dollars", xlab = NULL)
```
Avgwage has a positive skew.

#Bivariate analysis based on values found in corrplot.
The following variables showed a high correlation wih crime.
density, tax

```{r }
plot(density, crime)
```
```{r }
plot(log(density), crime)
```

We see a clear positive correlation.
```{r }
plot(tax, crime)
```
```{r }
plot(log(tax), crime)
```

#Looking at the relationship between police and crime. Common sense suggests that as the number of police per capita increases, crime should reduce. 
```{r }
plot(police, crime)
```
From the graph, we see an increase in the beginning.

```{r }
plot(log(police), crime)
```
```{r }
cor(police, crime)
```
By transforming the 
```{r }
cor(log(police), crime)
```

```{r }
plot(probconv, crime)
```
We see a slight increase in crime as the probconv increases initially but then it starts falling after a certain value.

```{r }
plot(probsen, crime)
```
```{r }
plot(log(ymale), crime)
```
```{r }
cor(log(ymale), crime)
```

```{r }
cor(ymale, crime)
```


#Initial model
Based on the univariate and bivariate analysis, we will build an initial model with the following variables.
density, tax, probconv, pro 

```{r}
model1 = lm(crime ~ tax + density + ymale + probarr + probconv + probsen + avgsen + pctmin + mix + avgwage + police)
coeftest(model1, vcov = vcovHC)
plot(model1)
```
```{r}
# modeled with only the significant variables
model2 = lm(crime ~ density + ymale + probconv + probsen + pctmin + police)
coeftest(model2, vcov = vcovHC)
plot(model2)
vif(model2)
```

```{r}
# modeled with only the significant variables
model3 = lm(crime ~ density + ymale + probconv + probsen + pctmin + log(police))
coeftest(model3, vcov = vcovHC)
plot(model3)
vif(model3)
```
```{r}
AIC(model3)
```
```{r}
# modeled with only the significant variables
model4 = lm(crime ~ density + ymale + probconv + probsen + pctmin )
coeftest(model4, vcov = vcovHC)
plot(model4)
vif(model4)
```
```{r}
AIC(model4)
```

```{r}
fit <- lm(crime~density+probconv+probsen,data=C)
#step <- stepAIC(fit, direction="both")
#step$anova
?step
#step(fit)
```


```{r}
C[, "maxwage"] <- apply(C[, 16:24], 1, max)
```

```{r}
C[, "minwage"] <- apply(C[, 16:24], 1, min)
```

```{r}
C$wagediff <- C$maxwage - C$minwage
```

```{r}
head(C)
```
```{r }
plot(C$wagediff, C$crime)
```
```{r }
plot(log(C$wagediff), C$crime)
```

```{r}
model5 = lm(crime ~ tax + density + ymale + probarr + probconv + probsen  + pctmin + mix + wagediff + police, data = C)
coeftest(model5, vcov = vcovHC)
plot(model5)
```

```{r}
model5 = lm(crime*1000 ~ tax + density + ymale + probarr + probconv + probsen  + pctmin + mix + wagediff + police, data = C)
coeftest(model5, vcov = vcovHC)
plot(model5)
```
```{r}
AIC(model5)
```

```{r}
model6 = lm(crime*1000 ~ tax + log(density)+ ymale + probarr + probconv + probsen  + pctmin + mix + wagediff + police, data = C)
coeftest(model6, vcov = vcovHC)
plot(model6)
```
```{r}
AIC(model6)
```


#Converting crime into per 1000, probconv and probsen into percentage
```{r}
crime_scaled <- crime*1000
pctconv <- probconv*100
pctsen <- probsen*100
police_scaled <- police*1000
```


```{r}
as_model1 = lm(crime_scaled ~ log(police) + pctsen + pctconv +log(tax) +log(density))
AIC1 = AIC(as_model1)
plot(as_model1)
summary(as_model1)
vif(as_model1)
```
```{r}
as_model1_pr = lm(crime_scaled ~ log(police) + pctsen + pctconv + log(density))
AIC_pr1 = AIC(as_model1_pr)
plot(as_model1_pr)
summary(as_model1_pr)
vif(as_model1_pr)
```
```{r}
as_model1_pr1 = lm(crime_scaled ~ police_scaled + pctsen + pctconv + density)
AIC_1_pr1 = AIC(as_model1_pr1)
plot(as_model1_pr1)
summary(as_model1_pr1)
vif(as_model1_pr1)
```

```{r}
as_model2 = lm(crime_scaled ~ police_scaled + pctsen + pctconv )
AIC2 = AIC(as_model2)
plot(as_model2)
summary(as_model2)
vif(as_model2)
```
```{r}
as_model2 = lm(scaledcrime ~ scaledpolice+ pctsen + pctconv + density + pctmin)
AIC2 = AIC(as_model2)
plot(as_model2)
vif(as_model2)
summary(as_model2)
```
```{r}
as_model2_pr = lm(crime_scaled ~ police + pctsen + pctconv + density + ymale + pctmin)
AIC1 = AIC(as_model2_pr)
plot(as_model2_pr)
summary(as_model2_pr)
vif(as_model2_pr)
```

```{r}
as_model2_pr = lm(crime_scaled ~ log(police) + pctsen + pctconv + log(density) + ymale + pctmin)
AIC_pr2 = AIC(as_model2_pr)
plot(as_model2_pr)
summary(as_model2_pr)
vif(as_model2_pr)
```
```{r}
AIC_pr1
AIC_pr2
```

#urban has 8 rows only
#33 are not in these three regions
#21 central
#34 west
# 5 in both west and urban
#1 in central and urban 
